<script type="text/javascript">
  const isValidUrl = (url) => {
    try {
      new URL(url);
      return true;
    } catch (e) {
      return false;
    }
  };

  const checkValidDefinyRpcServer = async (originUrl) => {
    const url = new URL(window.location.href);
    url.pathname = "/definy";
    const responseJson = await (
      await fetch(url, {
        method: "POST",
        body: "custom message!",
        body: JSON.stringify({ originUrl: originUrl }),
      })
    ).json();

    return responseJson.connectionResult;
  };

  // ブラウザで動作
  RED.nodes.registerType("send-to-definy", {
    category: "function",
    color: "#a6bbcf",
    defaults: {
      originUrl: {
        value: "",
        required: true,
        validate: isValidUrl,
      },
    },
    inputs: 1,
    outputs: 1,
    label: function () {
      console.log(this);
      return (
        this.originUrl + "の definy RPC サーバーと接続する" ??
        "definy RPC サーバーと接続. originUrl を設定してね"
      );
    },
    oneditsave: function (e) {},
  });

  window.definyOriginUrlOnInput = (e) => {
    const originUrl = document.getElementById("node-input-originUrl").value;
    const validationResult = document.getElementById(
      "definy-originUrl-validationResult"
    );
    if (!isValidUrl(originUrl)) {
      validationResult.textContent = originUrl + "は正当なURLではありません";
      return;
    }
    validationResult.textContent = originUrl + "に接続できるか試しています...";
    checkValidDefinyRpcServer(originUrl).then((ok) => {
      if (ok) {
        validationResult.textContent =
          originUrl +
          "は正当なURLで HTTP サーバーを公開していることを確認しました. definy RPC サーバーを実装できているかの確認はそのうちできるようにします";
        return;
      }
      validationResult.textContent =
        originUrl + "は正当なURLですが接続できませんでした.";
    });
  };
</script>

<script type="text/html" data-template-name="send-to-definy">
  <div class="form-row">
    <label for="node-input-originUrl"><i class="icon-tag"></i>originUrl</label>
    <input
      type="text"
      id="node-input-originUrl"
      placeholder="https://narumincho-definy.deno.dev/"
      oninput="definyOriginUrlOnInput()"
    />
    <div id="definy-originUrl-validationResult"></div>
  </div>
</script>

<script type="text/html" data-help-name="send-to-definy">
  <p>definy for Node RED</p>
</script>
