<script type="text/javascript">
  const isValidUrl = (url) => {
    try {
      new URL(url);
      return true;
    } catch (e) {
      return false;
    }
  };

  // ブラウザで動作
  RED.nodes.registerType("send-to-definy", {
    category: "function",
    color: "#a6bbcf",
    defaults: {
      originUrl: {
        value: "",
        required: true,
        validate: isValidUrl,
      },
    },
    inputs: 1,
    outputs: 1,
    label: function () {
      console.log(this);
      return (
        this.originUrl + "の definy RPC サーバーと接続する" ??
        "definy RPC サーバーと接続. originUrl を設定してね"
      );
    },
    oneditsave: function (e) {
      const url = new URL(window.location.href);
      url.pathname = "/definy";
      fetch(url, { method: "POST", body: "custom message!" }).then(
        (response) => {
          console.log(response);
          response.text().then(console.log);
        }
      );
      console.log("oneditsave", this);
    },
  });

  window.definyOriginUrlOnInput = (e) => {
    const originUrl = document.getElementById("node-input-originUrl").value;
    const validationResult = document.getElementById(
      "definy-originUrl-validationResult"
    );
    if (isValidUrl(originUrl)) {
      validationResult.textContent =
        originUrl +
        "は正当なURLです. このURLが示すサーバーが正しく definy RPC サーバーを実装できているかの確認はデプロイしたときに分かります (わかるようにします)";
    } else {
      validationResult.textContent = originUrl + "は正当なURLではありません";
    }
  };
</script>

<script type="text/html" data-template-name="send-to-definy">
  <div class="form-row">
    <label for="node-input-originUrl"><i class="icon-tag"></i>originUrl</label>
    <input
      type="text"
      id="node-input-originUrl"
      placeholder="https://narumincho-definy.deno.dev/"
      oninput="definyOriginUrlOnInput()"
    />
    <div id="definy-originUrl-validationResult"></div>
  </div>
</script>

<script type="text/html" data-help-name="send-to-definy">
  <p>definy for Node RED</p>
</script>
